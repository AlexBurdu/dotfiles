set-option -g default-terminal "tmux-256color"
set -g terminal-overrides ',xterm-256color:Tc'

unbind C-b
set-option -g prefix C-s

unbind r
bind r source-file ~/.config/tmux/tmux.conf \; \
  display-message "Config reloading..." \; \
  run-shell -b 'sleep 0.3 && ~/.config/tmux/set-themes.sh'

# Send focus events to pane applications (e.g. nvim) so they can
# react to FocusLost/FocusGained
set -g focus-events on
set-option -g mouse on
set-option -g status-position top

# Open current directory in Finder/File Explorer when clicking the
# status bar right side
if-shell '[ $(uname) = "Linux" ]' {
  bind -n MouseDown1StatusRight run-shell "xdg-open '#{pane_current_path}'"
  bind o run-shell "xdg-open '#{pane_current_path}'"
} {
  bind -n MouseDown1StatusRight run-shell "open '#{pane_current_path}'"
  bind o run-shell "open '#{pane_current_path}'"
}

# Prevent tmux from renaming windows automatically
set-option -g allow-rename off

# Keep tmux alive after closing session
set-option -g detach-on-destroy off

set-window-option -g mode-keys vi
# bind using n (normal) after prefix to trigger copy mode
bind n copy-mode
# Use y to copy selection to system clipboard
bind -T copy-mode-vi v send-keys -X begin-selection
# Bind y for copying to global clipboard in select mode based on OS
if-shell '[ $(uname) = "Linux" ]' {
  bind -T copy-mode-vi y \
    send-keys -X copy-pipe-and-cancel 'xclip -in -selection clipboard'
} {
  bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'pbcopy'
}
# bind p after prefix to paste from system clipboard
if-shell '[ $(uname) = "Linux" ]' {
  bind -T prefix p run-shell \
    "tmux set-buffer \"$(xclip -o -sel clip)\"; tmux paste-buffer"
} {
  bind -T prefix p run-shell \
    "tmux set-buffer \"$(pbpaste)\"; tmux paste-buffer"
}

# Smart pane switching with awareness of Vim splits.
# Manual implementation to allow custom C-\ binding
# Regex detects vim/nvim/fzf to forward keys instead of switching panes
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
  | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|l?n?vim?x?|fzf)(diff)?$'"
bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h' 'select-pane -L'
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j' 'select-pane -D'
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k' 'select-pane -U'
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l' 'select-pane -R'

bind-key -T copy-mode-vi 'C-h' select-pane -L
bind-key -T copy-mode-vi 'C-j' select-pane -D
bind-key -T copy-mode-vi 'C-k' select-pane -U
bind-key -T copy-mode-vi 'C-l' select-pane -R

# Bind C-\ for switching to the last session
bind-key -n C-\\ switch-client -l

# Bind prefix+\ for switching to the last session
bind-key \\ switch-client -l

# bind-key -n C-] next-window
bind-key ] next-window
# bind-key -n C-[ previous-window
bind-key [ previous-window

# List of plugins
set -g @plugin 'tmux-plugins/tpm'

# https://github.com/catppuccin/tmux
set -g @plugin 'catppuccin/tmux#v2.1.3'

# Set theme (clears stale vars, sets all catppuccin options for current mode)
run-shell '~/.config/tmux/set-themes.sh init'

# AI agent management — launch, monitor, orchestrate agents
set -g @plugin 'AlexBurdu/tmux-pilot'

# Enhanced window chooser with pane info (prefix+w)
bind w choose-tree -wF \
  "#{window_index}: #{window_name}  #{pane_title}  #{pane_current_path}"

# Pin plugin path so TPM's auto-detection doesn't split plugins across
# ~/.tmux/plugins/ and ~/.config/tmux/plugins/ on different machines
set-environment -g TMUX_PLUGIN_MANAGER_PATH "$HOME/.tmux/plugins/"

# Initialize TMUX plugin manager (keep at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'

# Status line modules (must be after TPM — catppuccin defines module variables)
set -g status-left "#{E:@catppuccin_status_session}"
set -gF status-left-length "200"
set -g status-right "#{E:@catppuccin_status_directory}"
set -gF status-right-length "200"
set -g status-justify "absolute-centre"
set -g window-status-separator " "

# Re-apply message styles after TPM (catppuccin overrides them)
run-shell '~/.config/tmux/set-themes.sh'

# New windows/splits inherit current pane's directory (must be after TPM)
bind c new-window -c "#{pane_current_path}"

# Create splits directionally (mirrors nvim's Space Space h/j/k/l)
bind h split-window -hb -c "#{pane_current_path}"
bind l split-window -h -c "#{pane_current_path}"
bind k split-window -b -c "#{pane_current_path}"
bind j split-window -c "#{pane_current_path}"

# Move panes directionally (uppercase H/J/K/L mirrors nvim's C-w H/J/K/L)
bind H swap-pane -s '{left-of}'
bind J swap-pane -s '{down-of}'
bind K swap-pane -s '{up-of}'
bind L swap-pane -s '{right-of}'

# Move window left/right
bind -r \{ swap-window -t -1 -d
bind -r \} swap-window -t +1 -d

# Open full scrollback in nvim (read-only, cursor at bottom)
bind v run-shell '\
  f="/tmp/tmux-scrollback-$(tmux display-message -p "#{pane_id}" | tr -d %).txt"; \
  tmux capture-pane -pS - > "$f" && \
  tmux new-window "nvim -R $f +\"normal G\""'

# Switch to last window
bind Enter last-window

# Theme picker — select dark/light/auto via popup menu
bind T run-shell '~/.config/tmux/theme-picker.sh'
